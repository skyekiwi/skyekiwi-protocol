# Metadata Structure

There are two types of Metadata handled by the SkyeKiwi Protocol. 

- **Pre-Seal Metadata**: Metadata before encrypted and shared with recipients.
- **Sealed Metadata**: Metadata after sealed. Able to be shared on public internet. 



## Upstream: Encrypt Input 

Reference: [driver.ts](https://github.com/skyekiwi/skyekiwi-protocol/blob/master/src/driver.ts) at

```javascript
private async upstreamChunkProcessingPipeLine(
  chunk: Uint8Array, chunkId: number, ipfs: IPFS
) 
```

Inputing byte stream will be divided into chunks. Size of chunks can be optimized according to network situation. These chunks will:

- Calculate Hash of Chunks
- Compressed
- Symmetrically Encrypted with a `sealingKey`. The Sealing Key is a randomly generated 32 bytes array. 
- Upload to IPFS
- Write CID and IPFS File Size to the **Pre-Seal Metadata**



After the byte stream is fully consumed, the `SkyeKiwi.Metadata` will start processing the Pre-Seal Metadata. The recorded list of Chunks will be encoded and encrypted by the **Sealing Key** and upload to IPFS:

Before Encryption:

```
CID1-CID2-CID3-CID4..... 
```



## Upstream: Pre-Seal
Reference: [metadata/index.ts](https://github.com/skyekiwi/skyekiwi-protocol/blob/master/src/metadata/index.ts) at

```javascript
public async generatePreSealingMetadata() -> Uint8Array {}
public static packagePreSeal(
  seal: Seal, hash: Uint8Array, chunksCID: Uint8Array
) -> Uint8Array
```



The resulting Metadata is **146 Bytes** Long:

- **32 Bytes**: Sealing Key
- **32 Bytes**: Hash of the File 
- **32 Bytes**: Author's Public Key
- **4 Bytes**: **SKYEKIWI_PROTOCOL** Version Code
- **46 Bytes**: CID of the list of **Chunks**



## Upstream: Seal
Reference: [metadata/index.ts](https://github.com/skyekiwi/skyekiwi-protocol/blob/master/src/metadata/index.ts) at

```javascript
public async generateSealedMetadata()
public static packageSealed(
  seal: Seal, preSealData: Uint8Array
) -> hex_string
```

Reference: [metadata/seal.ts](https://github.com/skyekiwi/skyekiwi-protocol/blob/master/src/metadata/seal.ts) at

```javascript
public seal(message: Uint8Array)-> {
  "public": hexstring
  "private": hexstring
}
```


The resulting Metadata size varies

- **32 Bytes**: The public key derived from the Sealing Key
- **Public TSS Pieces**: Public shares generated by TSS: encoded with `share1|share2|share3 ... `
- **Private TSS Pieces**: Pieces asymmetrically encrypted by `EncryptionSchema` and `SkyeKiwi.Box`: also encoded in `secretShare1|secretShare2|secretShare3 ...`
- **4 Bytes**: SKYEKIWI_PROTOCOL_VERSION



## Downstream

Basically reverse the process of Upstream



## UpdateEncryptionSchema

To update the encryptionSchema, only the encryption seal will need to be updated but the encrypted chunks themselves does not need to be updated. 



Therefore, after recovering the Pre-Sealed Metadata, the Driver will seal the Pre-Seal metadata again with the new EncryptionSchema. 





